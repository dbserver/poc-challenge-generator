# Node.js
# Build a general Node.js project with npm.
# Add steps that analyze code, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/javascript

trigger:
- main

pool:
  vmImage: ubuntu-latest

steps:

- task: Npm@1
  inputs:
    command: install
  displayName: "npm install"
  
- task: Npm@1
  inputs:
    customCommand: run build
  displayName: "run build"

- task: Docker@2
  inputs:
    containerRegistry: 'container-registry-celula'
    repository: 'challenge-generator'
    command: 'buildAndPush'
    Dockerfile: '**/Dockerfile'
    tags: |
      $(Build.BuildId)
      latest
  
- stage: DeployKubernetes
jobs:
  - job: ApplyManifests
    displayName: Applying kubernetes manifests
    steps:
      - task: KubernetesManifest@0
        displayName: Deploy to Kubernetes
        inputs:
          action: deploy
          namespace: challenge-generator
          kubernetesServiceConnection: AKS-DB
          manifests: |
            ./kubernetes/deployment.yaml
            ./kubernetes/service.yaml
          containers: |
            $(acrUrl):latest
      - task: Kubernetes@1
        displayName: Apply Ingress
        inputs:
          connectionType: Kubernetes Service Connection
          kubernetesServiceEndpoint: AKS-DB
          namespace: challenge-generator
          command: 'apply'
          useConfigurationFile: true
          configuration: './kubernetes/ingress.yaml'
          outputFormat: none
      
      - task: Kubernetes@1
        displayName: Restart service
        inputs:
          connectionType: Kubernetes Service Connection
          kubernetesServiceEndpoint: AKS-DB
          namespace: challenge-generator
          command: "rollout"
          arguments: "restart deploy challenge-generator"